{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///E:/memoriza/memoriza/codigo-fonte/memoriza-frontend/lib/auth-context.tsx"],"sourcesContent":["\"use client\";\n\nimport React, {\n  createContext,\n  useContext,\n  useEffect,\n  useState,\n  useCallback,\n  useMemo,\n} from \"react\";\n\ntype DecodedToken = {\n  id?: string;\n  email?: string;\n  firstName?: string;\n  lastName?: string;\n  fullName?: string;\n  userGroupId?: string;        // \"1\" ou \"2\"\n  isAdmin?: string | boolean;  // \"true\"/\"false\" ou boolean\n  authProvider?: string;       // Local ou Google\n  phone?: string;\n  [key: string]: unknown;\n};\n\ntype LoginResult = { success: true } | { success: false; error?: string };\ntype RegisterResult = { success: true } | { success: false; error?: string };\n\ntype AuthContextValue = {\n  token: string | null;\n  user: DecodedToken | null;\n  isAdmin: boolean;\n  login: (identifier: string, password: string) => Promise<LoginResult>;\n  register: (input: {\n    firstName: string;\n    lastName: string;\n    email: string;\n    password: string;\n    confirmPassword: string;\n    phone?: string;\n  }) => Promise<RegisterResult>;\n  loginWithToken: (jwt: string) => void; // usado no Google\n  logout: () => void;\n  updateUserFromProfile: (data: {\n    firstName?: string;\n    lastName?: string;\n    email?: string;\n    phone?: string;\n  }) => void;\n  isLoading: boolean;\n};\n\nconst AuthContext = createContext<AuthContextValue | undefined>(undefined);\n\nconst API_BASE_URL =\n  process.env.NEXT_PUBLIC_API_BASE_URL ?? \"https://localhost:7105\";\n\n/* ======================================================\n   Decodificação do JWT (com correção de padding)\n====================================================== */\nfunction decodeJwt(token: string): DecodedToken | null {\n  try {\n    const payload = token.split(\".\")[1];\n    if (!payload) return null;\n\n    let base64 = payload.replace(/-/g, \"+\").replace(/_/g, \"/\");\n\n    // padding faltante\n    const pad = base64.length % 4;\n    if (pad === 2) base64 += \"==\";\n    else if (pad === 3) base64 += \"=\";\n\n    const json = atob(base64);\n    return JSON.parse(json);\n  } catch {\n    return null;\n  }\n}\n\n/* ======================================================\n   Normalização do usuário (fora do componente)\n====================================================== */\nfunction normalizeUser(decoded: DecodedToken): DecodedToken {\n  const provider =\n    decoded.authProvider ??\n    (decoded as any).AuthProvider ??\n    (decoded as any).provider ??\n    \"Local\";\n\n  const normalizedProvider =\n    typeof provider === \"string\" ? provider.trim() : \"Local\";\n\n  const firstName = decoded.firstName as string | undefined;\n  const lastName = decoded.lastName as string | undefined;\n\n  let fullName = decoded.fullName as string | undefined;\n  if (!fullName && firstName) {\n    fullName = lastName ? `${firstName} ${lastName}` : firstName;\n  }\n\n  return {\n    ...decoded,\n    authProvider: normalizedProvider || \"Local\",\n    fullName,\n  };\n}\n\n/* ======================================================\n   AuthProvider\n====================================================== */\nexport const AuthProvider: React.FC<{ children: React.ReactNode }> = ({\n  children,\n}) => {\n  const [token, setToken] = useState<string | null>(null);\n  const [user, setUser] = useState<DecodedToken | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // Carrega token do localStorage no primeiro render\n  useEffect(() => {\n    if (typeof window === \"undefined\") return;\n\n    const stored = window.localStorage.getItem(\"memoriza_token\");\n    if (stored) {\n      const decoded = decodeJwt(stored);\n      if (decoded) {\n        const normalized = normalizeUser(decoded);\n        setToken(stored);\n        setUser(normalized);\n      }\n    }\n    setIsLoading(false);\n  }, []);\n\n  /* ======================================================\n     Aplica token + salva no localStorage + decodifica\n     (memoizado para não mudar a referência a cada render)\n  ====================================================== */\n  const applyToken = useCallback((jwt: string) => {\n    if (typeof window !== \"undefined\") {\n      window.localStorage.setItem(\"memoriza_token\", jwt);\n    }\n\n    const decoded = decodeJwt(jwt);\n    if (decoded) {\n      const normalized = normalizeUser(decoded);\n      setUser(normalized);\n    } else {\n      setUser(null);\n    }\n\n    setToken(jwt);\n  }, []);\n\n  // Usado no callback do Google\n  const loginWithToken = useCallback(\n    (jwt: string) => {\n      applyToken(jwt);\n    },\n    [applyToken]\n  );\n\n  /* ======================================================\n     LOGIN NORMAL (memoizado)\n  ====================================================== */\n  const login = useCallback(\n    async (identifier: string, password: string): Promise<LoginResult> => {\n      try {\n        const response = await fetch(`${API_BASE_URL}/api/Auth/login`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ identifier, password }),\n        });\n\n        const data = await response.json();\n        if (!response.ok || !data?.token) {\n          return {\n            success: false,\n            error:\n              data?.message ||\n              \"Não foi possível fazer login. Tente novamente.\",\n          };\n        }\n\n        applyToken(data.token);\n        return { success: true };\n      } catch (error) {\n        console.error(\"Erro ao fazer login:\", error);\n        return {\n          success: false,\n          error:\n            \"Erro ao conectar ao servidor. Verifique sua conexão e tente novamente.\",\n        };\n      }\n    },\n    [applyToken]\n  );\n\n  /* ======================================================\n     REGISTER NORMAL (memoizado)\n  ====================================================== */\n  const register = useCallback(\n    async (input: {\n      firstName: string;\n      lastName: string;\n      email: string;\n      password: string;\n      confirmPassword: string;\n      phone?: string;\n    }): Promise<RegisterResult> => {\n      try {\n        const response = await fetch(`${API_BASE_URL}/api/Auth/register`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(input),\n        });\n\n        const data = await response.json();\n        if (!response.ok || !data?.token) {\n          return {\n            success: false,\n            error:\n              data?.message ||\n              \"Não foi possível criar a conta. Verifique os dados e tente novamente.\",\n          };\n        }\n\n        applyToken(data.token);\n        return { success: true };\n      } catch (error) {\n        console.error(\"Erro ao registrar usuário:\", error);\n        return {\n          success: false,\n          error:\n            \"Erro ao conectar ao servidor. Verifique sua conexão e tente novamente.\",\n        };\n      }\n    },\n    [applyToken]\n  );\n\n  /* ======================================================\n     LOGOUT (memoizado)\n  ====================================================== */\n  const logout = useCallback(() => {\n    setToken(null);\n    setUser(null);\n    if (typeof window !== \"undefined\") {\n      window.localStorage.removeItem(\"memoriza_token\");\n    }\n  }, []);\n\n  /* ======================================================\n     Atualiza dados do usuário vindos da página de perfil\n  ====================================================== */\n  const updateUserFromProfile = useCallback(\n    (data: { firstName?: string; lastName?: string; email?: string; phone?: string }) => {\n      setUser((prev) => {\n        if (!prev) return prev;\n\n        const next: DecodedToken = {\n          ...prev,\n          ...data,\n        };\n\n        const fn = (data.firstName ?? prev.firstName) as string | undefined;\n        const ln = (data.lastName ?? prev.lastName) as string | undefined;\n\n        if (fn) {\n          next.fullName = ln ? `${fn} ${ln}` : fn;\n        }\n\n        return next;\n      });\n    },\n    []\n  );\n\n  /* ======================================================\n     ADMIN CHECK (1 = comum, 2 = admin)\n  ====================================================== */\n  const isAdmin =\n    !!user &&\n    (user?.isAdmin === true ||\n      user?.isAdmin === \"true\" ||\n      user?.userGroupId === \"2\");\n\n  const value = useMemo<AuthContextValue>(\n    () => ({\n      token,\n      user,\n      isAdmin,\n      isLoading,\n      login,\n      register,\n      loginWithToken,\n      logout,\n      updateUserFromProfile,\n    }),\n    [token, user, isAdmin, isLoading, login, register, loginWithToken, logout, updateUserFromProfile]\n  );\n\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\n};\n\n// Hook\nexport const useAuth = (): AuthContextValue => {\n  const ctx = useContext(AuthContext);\n  if (!ctx) {\n    throw new Error(\"useAuth deve ser utilizado dentro de um AuthProvider\");\n  }\n  return ctx;\n};"],"names":[],"mappings":"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"}}]
}