{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///E:/memoriza/codigo-fonte/memoriza-frontend/lib/auth-context.tsx"],"sourcesContent":["\"use client\";\n\nimport React, { createContext, useContext, useEffect, useState } from \"react\";\n\ntype DecodedToken = {\n  id?: string;\n  email?: string;\n  firstName?: string;\n  lastName?: string;\n  fullName?: string;\n  userGroupId?: string;        // \"1\" ou \"2\"\n  isAdmin?: string | boolean;  // \"true\"/\"false\" ou boolean\n  authProvider?: string;\n  phone?: string;\n  [key: string]: unknown;\n};\n\ntype LoginResult = { success: true } | { success: false; error?: string };\ntype RegisterResult = { success: true } | { success: false; error?: string };\n\ntype AuthContextValue = {\n  token: string | null;\n  user: DecodedToken | null;\n  isAdmin: boolean;\n  login: (identifier: string, password: string) => Promise<LoginResult>;\n  register: (input: {\n    firstName: string;\n    lastName: string;\n    email: string;\n    password: string;\n    confirmPassword: string;\n    phone?: string;\n  }) => Promise<RegisterResult>;\n  /** usado pelo Google callback pra logar direto com o JWT */\n  loginWithToken: (jwt: string) => void;\n  logout: () => void;\n};\n\nconst AuthContext = createContext<AuthContextValue | undefined>(undefined);\n\nconst API_BASE_URL =\n  process.env.NEXT_PUBLIC_API_BASE_URL ?? \"https://localhost:7105\";\n\nfunction decodeJwt(token: string): DecodedToken | null {\n  try {\n    const payload = token.split(\".\")[1];\n    const json = atob(payload.replace(/-/g, \"+\").replace(/_/g, \"/\"));\n    return JSON.parse(json);\n  } catch {\n    return null;\n  }\n}\n\nexport const AuthProvider: React.FC<{ children: React.ReactNode }> = ({\n  children,\n}) => {\n  const [token, setToken] = useState<string | null>(null);\n  const [user, setUser] = useState<DecodedToken | null>(null);\n\n  // Carrega token do localStorage no primeiro render\n  useEffect(() => {\n    if (typeof window === \"undefined\") return;\n    const stored = window.localStorage.getItem(\"memoriza_token\");\n    if (stored) {\n      setToken(stored);\n      const decoded = decodeJwt(stored);\n      if (decoded) setUser(decoded);\n    }\n  }, []);\n\n  const applyToken = (jwt: string) => {\n    setToken(jwt);\n    if (typeof window !== \"undefined\") {\n      window.localStorage.setItem(\"memoriza_token\", jwt);\n    }\n    const decoded = decodeJwt(jwt);\n    if (decoded) setUser(decoded);\n  };\n\n  const loginWithToken = (jwt: string) => {\n    applyToken(jwt);\n  };\n\n  const login = async (\n    identifier: string,\n    password: string\n  ): Promise<LoginResult> => {\n    try {\n      const response = await fetch(`${API_BASE_URL}/api/Auth/login`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          identifier,\n          password,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        return {\n          success: false,\n          error:\n            data?.message ||\n            \"Não foi possível fazer login. Tente novamente.\",\n        };\n      }\n\n      if (!data?.token) {\n        return {\n          success: false,\n          error: \"Resposta inválida do servidor. Token não encontrado.\",\n        };\n      }\n\n      applyToken(data.token);\n      return { success: true };\n    } catch (error) {\n      console.error(\"Erro ao fazer login:\", error);\n      return {\n        success: false,\n        error:\n          \"Erro ao conectar ao servidor. Verifique sua conexão e tente novamente.\",\n      };\n    }\n  };\n\n  const register = async (input: {\n    firstName: string;\n    lastName: string;\n    email: string;\n    password: string;\n    confirmPassword: string;\n    phone?: string;\n  }): Promise<RegisterResult> => {\n    try {\n      const response = await fetch(`${API_BASE_URL}/api/Auth/register`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(input),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        return {\n          success: false,\n          error:\n            data?.message ||\n            \"Não foi possível criar a conta. Verifique os dados e tente novamente.\",\n        };\n      }\n\n      if (!data?.token) {\n        return {\n          success: false,\n          error:\n            \"Resposta inválida do servidor. Token não encontrado após o cadastro.\",\n        };\n      }\n\n      applyToken(data.token);\n      return { success: true };\n    } catch (error) {\n      console.error(\"Erro ao registrar usuário:\", error);\n      return {\n        success: false,\n        error:\n          \"Erro ao conectar ao servidor. Verifique sua conexão e tente novamente.\",\n      };\n    }\n  };\n\n  const logout = () => {\n    setToken(null);\n    setUser(null);\n    if (typeof window !== \"undefined\") {\n      window.localStorage.removeItem(\"memoriza_token\");\n    }\n  };\n\n  // UsuarioComum = 1, Admin = 2\n  const isAdmin =\n    !!user &&\n    (\n      user.isAdmin === true ||\n      user.isAdmin === \"true\" ||\n      user.userGroupId === \"2\"\n    );\n\n  return (\n    <AuthContext.Provider\n      value={{ token, user, isAdmin, login, register, loginWithToken, logout }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n};\n\nexport const useAuth = (): AuthContextValue => {\n  const ctx = useContext(AuthContext);\n  if (!ctx) {\n    throw new Error(\"useAuth deve ser utilizado dentro de um AuthProvider\");\n  }\n  return ctx;\n};"],"names":[],"mappings":";;;;;;;AAEA;AAFA;;;AAsCA,MAAM,4BAAc,IAAA,sNAAa,EAA+B;AAEhE,MAAM,eACJ,QAAQ,GAAG,CAAC,wBAAwB,IAAI;AAE1C,SAAS,UAAU,KAAa;IAC9B,IAAI;QACF,MAAM,UAAU,MAAM,KAAK,CAAC,IAAI,CAAC,EAAE;QACnC,MAAM,OAAO,KAAK,QAAQ,OAAO,CAAC,MAAM,KAAK,OAAO,CAAC,MAAM;QAC3D,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,MAAM,eAAwD,CAAC,EACpE,QAAQ,EACT;IACC,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,iNAAQ,EAAgB;IAClD,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,iNAAQ,EAAsB;IAEtD,mDAAmD;IACnD,IAAA,kNAAS,EAAC;QACR,wCAAmC;;;QACnC,MAAM;IAMR,GAAG,EAAE;IAEL,MAAM,aAAa,CAAC;QAClB,SAAS;QACT;;QAGA,MAAM,UAAU,UAAU;QAC1B,IAAI,SAAS,QAAQ;IACvB;IAEA,MAAM,iBAAiB,CAAC;QACtB,WAAW;IACb;IAEA,MAAM,QAAQ,OACZ,YACA;QAEA,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,eAAe,CAAC,EAAE;gBAC7D,QAAQ;gBACR,SAAS;oBACP,gBAAgB;gBAClB;gBACA,MAAM,KAAK,SAAS,CAAC;oBACnB;oBACA;gBACF;YACF;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAEhC,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,OAAO;oBACL,SAAS;oBACT,OACE,MAAM,WACN;gBACJ;YACF;YAEA,IAAI,CAAC,MAAM,OAAO;gBAChB,OAAO;oBACL,SAAS;oBACT,OAAO;gBACT;YACF;YAEA,WAAW,KAAK,KAAK;YACrB,OAAO;gBAAE,SAAS;YAAK;QACzB,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,wBAAwB;YACtC,OAAO;gBACL,SAAS;gBACT,OACE;YACJ;QACF;IACF;IAEA,MAAM,WAAW,OAAO;QAQtB,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,aAAa,kBAAkB,CAAC,EAAE;gBAChE,QAAQ;gBACR,SAAS;oBACP,gBAAgB;gBAClB;gBACA,MAAM,KAAK,SAAS,CAAC;YACvB;YAEA,MAAM,OAAO,MAAM,SAAS,IAAI;YAEhC,IAAI,CAAC,SAAS,EAAE,EAAE;gBAChB,OAAO;oBACL,SAAS;oBACT,OACE,MAAM,WACN;gBACJ;YACF;YAEA,IAAI,CAAC,MAAM,OAAO;gBAChB,OAAO;oBACL,SAAS;oBACT,OACE;gBACJ;YACF;YAEA,WAAW,KAAK,KAAK;YACrB,OAAO;gBAAE,SAAS;YAAK;QACzB,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,8BAA8B;YAC5C,OAAO;gBACL,SAAS;gBACT,OACE;YACJ;QACF;IACF;IAEA,MAAM,SAAS;QACb,SAAS;QACT,QAAQ;QACR;;IAGF;IAEA,8BAA8B;IAC9B,MAAM,UACJ,CAAC,CAAC,QACF,CACE,KAAK,OAAO,KAAK,QACjB,KAAK,OAAO,KAAK,UACjB,KAAK,WAAW,KAAK,GACvB;IAEF,qBACE,8OAAC,YAAY,QAAQ;QACnB,OAAO;YAAE;YAAO;YAAM;YAAS;YAAO;YAAU;YAAgB;QAAO;kBAEtE;;;;;;AAGP;AAEO,MAAM,UAAU;IACrB,MAAM,MAAM,IAAA,mNAAU,EAAC;IACvB,IAAI,CAAC,KAAK;QACR,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT"}}]
}